setLocal("0.0.0.0:53", {})
setSecurityPollSuffix("")

newServer({
    pool                          = "bind",
    address                       = "192.168.1.2:5300",
    healthCheckMode               = "lazy",
    checkInterval                 = 1,
    maxCheckFailures              = 3,
    lazyHealthCheckFailedInterval = 30,
    rise                          = 2,
    lazyHealthCheckThreshold      = 30,
    lazyHealthCheckSampleSize     = 100,
    lazyHealthCheckMinSampleCount = 10,
    lazyHealthCheckMode           = "TimeoutOnly",
    useClientSubnet               = true
})

newServer({
    pool                          = "blocky",
    address                       = "192.168.1.2:5301",
    healthCheckMode               = "lazy",
    checkInterval                 = 1800,
    maxCheckFailures              = 3,
    lazyHealthCheckFailedInterval = 30,
    rise                          = 2,
    lazyHealthCheckThreshold      = 30,
    lazyHealthCheckSampleSize     = 100,
    lazyHealthCheckMinSampleCount = 10,
    lazyHealthCheckMode           = "TimeoutOnly",
    useClientSubnet               = true
})
setECSSourcePrefixV4(32) -- Forward requester IP to Blocky

newServer({
    pool                 = "cloudflare",
    address              = "1.1.1.1:853",
    tls                  = "openssl",
    reconnectOnUp        = true,
    subjectName          = "cloudflare-dns.com",
    validateCertificates = true,
    checkInterval        = 10,
    checkTimeout         = 2000
})

newServer({
    pool                 = "cloudflare",
    address              = "1.0.0.1:853",
    tls                  = "openssl",
    reconnectOnUp        = true,
    subjectName          = "cloudflare-dns.com",
    validateCertificates = true,
    checkInterval        = 10,
    checkTimeout         = 2000
})

newServer({
    pool                 = "cloudflare",
    address              = "1.1.1.1",
    subjectName          = "cloudflare",
    checkInterval        = 10,
    checkTimeout         = 2000
})

newServer({
    pool                 = "cloudflare",
    address              = "1.0.0.1",
    subjectName          = "cloudflare",
    checkInterval        = 10,
    checkTimeout         = 2000
})

pc = newPacketCache(10000, {
    maxTTL              = 86400,
    minTTL              = 0,
    temporaryFailureTTL = 60,
    staleTTL            = 60,
    dontAge             = false
})
getPool(""):setCache(pc)

addAction("192.168.6.0/24", PoolAction("cloudflare"))  -- Guest
addAction("192.168.6.0/24", DropAction())              -- Guest
addAction("192.168.10.0/24", PoolAction("cloudflare")) -- IOT
addAction("192.168.10.0/24", DropAction())             -- IOT
addAction("192.168.20.0/24", PoolAction("cloudflare")) -- Camera
addAction("192.168.20.0/24", DropAction())             -- Camera

addAction('j8g.dev', PoolAction('bind'))
addAction('jory.casa', PoolAction('bind'))
addAction('jory.dev', PoolAction('bind'))
addAction('168.192.in-addr.arpa', PoolAction('bind'))

addAction("192.168.1.0/24", PoolAction("blocky"))      -- LAN
addAction("192.168.30.0/24", PoolAction("blocky"))     -- Trusted
addAction("10.69.1.0/24", PoolAction("blocky"))        -- Server
