setLocal("0.0.0.0:53", {})
setSecurityPollSuffix("")
setECSSourcePrefixV4(32)

newServer({
    pool                          = "blocky",
    address                       = "10.69.1.99:5301",
    healthCheckMode               = "lazy",
    checkInterval                 = 10,
    maxCheckFailures              = 3,
    lazyHealthCheckFailedInterval = 30,
    rise                          = 2,
    lazyHealthCheckThreshold      = 30,
    lazyHealthCheckSampleSize     = 100,
    lazyHealthCheckMinSampleCount = 10,
    lazyHealthCheckMode           = "TimeoutOnly",
    useClientSubnet               = true
})

newServer({
    pool                          = "bind",
    address                       = "10.69.1.99:5300",
    healthCheckMode               = "lazy",
    checkInterval                 = 10,
    maxCheckFailures              = 3,
    lazyHealthCheckFailedInterval = 30,
    rise                          = 2,
    lazyHealthCheckThreshold      = 30,
    lazyHealthCheckSampleSize     = 100,
    lazyHealthCheckMinSampleCount = 10,
    lazyHealthCheckMode           = "TimeoutOnly",
    useClientSubnet               = true
})

newServer({
    pool                 = "cloudflare",
    address              = "1.1.1.1:853",
    tls                  = "openssl",
    subjectName          = "cloudflare-dns.com",
    validateCertificates = true,
    checkInterval        = 10,
    checkTimeout         = 2000
})

newServer({
    pool                 = "cloudflare",
    address              = "1.0.0.1:853",
    tls                  = "openssl",
    subjectName          = "cloudflare-dns.com",
    validateCertificates = true,
    checkInterval        = 10,
    checkTimeout         = 2000
})

pc = newPacketCache(10000, {
    maxTTL              = 86400,
    minTTL              = 0,
    temporaryFailureTTL = 60,
    staleTTL            = 60,
    dontAge             = false
})
getPool(""):setCache(pc)

-- Guest Network : Only route to Cloudflare
addAction("192.168.6.0/24", PoolAction("cloudflare"))
addAction("192.168.6.0/24", DropAction())

-- IOT Network : Only route to Cloudflare
addAction("192.168.10.0/24", PoolAction("cloudflare"))
addAction("192.168.10.0/24", DropAction())

-- Camera Network : Only route to Cloudflare
addAction("192.168.20.0/24", PoolAction("cloudflare"))
addAction("192.168.20.0/24", DropAction())

-- Trusted Zones : Routes to Bind
addAction('j8g.dev', PoolAction('bind'))
addAction('jory.casa', PoolAction('bind'))
addAction('jory.dev', PoolAction('bind'))
addAction('168.192.in-addr.arpa', PoolAction('bind'))

-- Trusted Networks : Routes to Cloudflare or Blocky
addAction("192.168.1.0/24", PoolAction("blocky"))
addAction("10.42.1.0/24", PoolAction("blocky"))
addAction("10.69.1.0/24", PoolAction("blocky"))
